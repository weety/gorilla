/*
 * File      : fuzzy_pid.c
 *
 * Change Logs:
 * Date           Author       Notes
 * 2019-06-10     weety    first version.
 */

#include "fuzzy_pid.h"
#include "param.h"

static float FuzzyKpLookUpTable[LANGUAGE_DOMAIN_RANGE*2 + 1][LANGUAGE_DOMAIN_RANGE*2 + 1] = {
	{4.572377,4.071458,3.586251,3.426962,3,2.543851,2.254813,1.878483,2.07928,2.242539,2.597132,2.833701,3},
	{4.391608,3.999014,3.493299,3.289459,2.889875,2.378737,2.101118,1.828901,2.121295,2.338832,2.676525,2.964073,3.128539},
	{4.280956,3.924184,3.33902,3.126612,2.830376,2.289893,2.044094,1.832842,2.07928,2.401332,2.780782,3.087198,3.200159},
	{4.23992,3.904803,3.329955,3,2.670045,2.095197,1.832842,1.928542,2.288422,2.497752,2.882406,3.296594,3.418881},
	{4.280956,3.84445,3.169624,2.873388,2.66098,2.075816,1.719044,2.03486,2.479288,2.634901,3,3.456149,3.745187},
	{4.167159,3.904803,3.174965,2.716424,2.507073,2.000986,1.608392,1.928542,2.394472,2.654377,3.110125,3.621263,3.898882},
	{3.955906,3.710107,3.169624,2.707602,2.413749,1.928542,1.427623,1.928542,2.413749,2.707602,3.169624,3.710107,3.955906},
	{3.898882,3.621263,3.110125,2.654377,2.394472,1.928542,1.608392,2.000986,2.507073,2.716424,3.174965,3.845614,4.105154},
	{3.745187,3.456149,3,2.634901,2.479288,2.03486,1.719044,2.075816,2.66098,2.873388,3.169624,3.845614,4.279843},
	{3.418881,3.296594,2.882406,2.497752,2.288422,1.928542,1.832842,2.095197,2.670045,3,3.329955,3.904803,4.30885},
	{3.200159,3.087198,2.780782,2.401332,2.07928,1.832842,2.044094,2.289893,2.830376,3.126612,3.33902,3.924184,4.280956},
	{3.128539,2.964073,2.676525,2.338832,2.121295,1.828901,2.101118,2.378737,2.889875,3.289459,3.493299,3.999014,4.391608},
	{3,2.833701,2.597132,2.242539,2.07928,1.878483,2.254813,2.543851,3,3.426962,3.586251,4.071458,4.572377},
};

static float FuzzyKdLookUpTable[LANGUAGE_DOMAIN_RANGE*2 + 1][LANGUAGE_DOMAIN_RANGE*2 + 1] = {
	{3.305543,2.900346,2.603319,2.071819,1.720157,1.756197,1.967769,1.93751,2.044094,2.101118,2.254813,2.101007,2.07928},
	{3.405757,3.071843,2.66797,2.071819,1.751465,1.884258,1.93751,2.097154,2.23957,2.334241,2.497139,2.279773,2.174031},
	{3.376391,3.01994,2.668181,2.071819,1.720157,1.83365,2.044094,2.23957,2.597132,2.676525,2.780782,2.532421,2.413749},
	{3.364584,3.077853,2.719325,2.071819,1.616422,1.652241,2.020596,2.279773,2.676525,2.964073,2.913768,2.648845,2.439684},
	{3.169624,2.873388,2.66098,2.071819,1.470624,1.72176,2.07928,2.401332,2.780782,2.913768,2.964394,2.804589,2.597132},
	{2.951416,2.654377,2.442019,2.000986,1.928542,1.928542,2.121295,2.446877,2.642726,2.790498,2.738032,2.658129,2.676525},
	{2.780782,2.592266,2.479288,2.522744,2.479288,2.288422,2.07928,2.288422,2.479288,2.522744,2.479288,2.592266,2.780782},
	{2.676525,2.658129,2.738032,2.790498,2.642726,2.446877,2.121295,1.928542,1.928542,2.000986,2.442019,2.654377,2.951416},
	{2.597132,2.804589,2.964394,2.913768,2.780782,2.401332,2.07928,1.72176,1.470624,2.071819,2.66098,2.873388,3.169624},
	{2.439684,2.648845,2.913768,2.964073,2.676525,2.279773,2.020596,1.652241,1.616422,2.071819,2.719325,3.077853,3.364584},
	{2.413749,2.532421,2.780782,2.676525,2.597132,2.23957,2.044094,1.83365,1.720157,2.071819,2.668181,3.01994,3.376391},
	{2.174031,2.279773,2.497139,2.334241,2.23957,2.097154,1.93751,1.884258,1.751465,2.071819,2.66797,3.071843,3.405757},
	{2.07928,2.101007,2.254813,2.101118,2.044094,1.93751,1.967769,1.756197,1.720157,2.071819,2.603319,2.900346,3.305543},
};

void fuzzy_pid_angle(float e, float ec, fuzzy_pid_param *param)
{
	float fuzzy_angle_kp = 0.0f;
	float fuzzy_angle_kd = 0.0f;
	float kfp;
	float kfd;
	float fuzzy_kp;
	float fuzzy_kd;
	float es;
	float ecs;

	if (e < -E_MAX)
		e = -E_MAX;
	if (e > E_MAX)
		e = E_MAX;

	if (ec < -EC_MAX)
		ec = -EC_MAX;
	if (ec > EC_MAX)
		ec = EC_MAX;

	es = e * E_EXPANSION_FACTOR * KE + LANGUAGE_DOMAIN_RANGE;
	if (es > 0)
		es += 0.5f;
	else
		es -= 0.5f;
	ecs = ec * EC_EXPANSION_FACTOR * KEC + LANGUAGE_DOMAIN_RANGE;
	if (ecs > 0)
		ecs += 0.5f;
	else
		ecs -= 0.5f;

	param_get_by_idx(FUZZY_PID_KP, &fuzzy_angle_kp);
	param_get_by_idx(FUZZT_PID_KD, &fuzzy_angle_kd);

	kfp = LANGUAGE_DOMAIN_RANGE/fuzzy_angle_kp;
	kfd = LANGUAGE_DOMAIN_RANGE/fuzzy_angle_kd;

	fuzzy_kp = FuzzyKpLookUpTable[(int)ecs][(int)es];
	fuzzy_kd = FuzzyKdLookUpTable[(int)ecs][(int)es];

	/* defuzzy */
	param->kp = fuzzy_kp / kfp;
	param->kd = fuzzy_kd / kfd;
}

